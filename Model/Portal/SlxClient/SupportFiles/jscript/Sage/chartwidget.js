define(["require","exports","lime"],function(a,b,c){var d=function(){function a(a){var b=this;this.scope=a,this.hideText=!1,this.hideChart=!1,this.widgetContext=a[c.WidgetConstants.widgetContextKey];var d=a[c.WidgetConstants.widgetInstanceKey];this.widgetContext.getSettings();this.widgetInstanceId=this.widgetContext.getWidgetInstanceId();var e=new Date;this.dateTime=e.getTime().toString(),d.settingsSaved=function(a){b.setContent()},d.widgetSettingsFactory=function(a){var b={};return b.angularConfig={relativeTemplateUrl:"settings.html",scopeValue:{name:"settingsData",value:{settingsContext:a,settingsInstance:b}}},b},this.language=this.widgetContext.getLanguage(),this.setContent()}return a.prototype.showSettingsDialog=function(){this.widgetContext.getSettings().showSettings()},a.prototype.isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},a.prototype.setContent=function(){var a,b=this,c=this.widgetContext.getSettings(),d=c.get("entity");a=c.get("group");var e=c.get("filter"),f=c.get("metric"),g=c.get("chartType"),h=c.get("limitCount");if(d&&a&&e&&f&&g&&h){var i=this;this.setBusy(!0);var j=c.get("SDataApiContext"),k=j+'/SData/slx/system/-/groups("{0}")/$queries/executeMetric?format=json&_filterName={1}&_metricName={2}&limit={3}&count={4}&_t={5}';k=this.format([k,a.key,e,f,h,h,this.dateTime]);var l=this.createRequest(encodeURI(k));l.withCredentials=!0,this.widgetContext.executeIonApiAsync(l).then(function(a){for(var c=a.data.$resources,d=[],e=0;e<c.length;e++)if(0!==c[e].value&&b.isNumeric(c[e].value)){var f={name:c[e].$descriptor,value:c[e].value};d.push(f)}if(0===c.length||0===d.length)i.textValue=i.language.noData,i.hideText=!1,i.hideChart=!0,i.setBusy(!1);else{var h=[{data:d}];i.chartOptions={type:g.charAt(0).toLowerCase()+g.slice(1),dataset:h},i.hideText=!0,i.hideChart=!1,i.setBusy(!1)}},function(a){b.onRequestError(a)})}else this.textValue=this.language.notConfigured,this.hideText=!1,this.hideChart=!0},a.add=function(b){b.controller("inforCRMChartMainCtrl",a)},a.prototype.format=function(a){for(var b=a[0],c=0;c<a.length-1;c++){var d=new RegExp("\\{"+c+"\\}","gm");b=b.replace(d,a[c+1])}return b},a.prototype.setBusy=function(a){this.widgetContext.setState(a?c.WidgetState.busy:c.WidgetState.running)},a.prototype.onRequestError=function(a){this.textValue=this.language.errorOccured,this.setBusy(!1)},a.prototype.createRequest=function(a){var b={method:"GET",url:a,cache:!1,headers:{Accept:"application/json"}};return b},a.$inject=["$scope"],a}(),e=function(){function a(a){var b=this;this.scope=a,this.entityChanged=function(){var a=this,b=this,c=this.dateTime,d=this.entityValue||this.widgetContext.getSettings().get("entity");if(d){b.isGroupBusy=!0,b.isFilterBusy=!0,b.isMetricBusy=!0,b.groupDropdownOptions=null,b.filterDropdownOptions=null,b.metricDropdownOptions=null;var e=b.widgetContext.getSettings().get("SDataApiContext"),f=e+"/SData/slx/system/-/groups?startIndex=0&count=300&where=upper(family) eq upper('{0}')&select=name,displayName&orderBy=name&format=json&_t={1}";f=b.format([f,d.value,c]);var g=this.createRequest(encodeURI(f));g.withCredentials=!0,this.widgetContext.executeIonApiAsync(g).then(function(a){var c,d,e=a.data.$resources,f=[];for(d=0;d<e.length;d++)c={name:e[d].name,key:e[d].$key},f.push(c);b.groupOptions=f;var g=b.widgetContext.getSettings().get("group"),h=!1;if(g&&g.name)for(d=0;d<f.length;d++)if(g.name===f[d].name){b.groupValue=f[d],h=!0;break}h===!1&&(b.groupValue=f[0]),b.groupDropdownOptions?b.groupDropdownOptions=null:b.groupDropdownOptions={},b.isGroupBusy=!1},function(b){a.onRequestError(b)});var h=e+"/SData/slx/metadata/-/entities(\"{0}\")/filters?startIndex=0&count=300&where=analyticsAvailable and filterType ne 'analyticsMetric'&select=filterName,displayName,analyticsDescription&orderBy=filterName&format=json&_t={1}";h=b.format([h,d.name,c]);var i=this.createRequest(encodeURI(h));i.withCredentials=!0,this.widgetContext.executeIonApiAsync(i).then(function(a){for(var c=a.data.$resources,d=[],e=0;e<c.length;e++)d.push(c[e].filterName);b.filterOptions=d;var f=b.widgetContext.getSettings().get("filter");f&&d.indexOf(f)>-1?b.dimensionValue=f:b.dimensionValue=d[0],b.filterDropdownOptions?b.filterDropdownOptions=null:b.filterDropdownOptions={},b.isFilterBusy=!1},function(b){a.onRequestError(b)});var j=e+"/SData/slx/metadata/-/entities(\"{0}\")/filters?_compact=true&startIndex=0&count=300&where=analyticsAvailable and filterType eq 'analyticsMetric'&select=filterName,displayName,analyticsDescription&orderBy=filterName&format=json&_t={1}";j=b.format([j,d.name,c]);var k=this.createRequest(encodeURI(j));k.withCredentials=!0,this.widgetContext.executeIonApiAsync(k).then(function(a){for(var c=a.data.$resources,d=[],e=0;e<c.length;e++)d.push(c[e].filterName);b.metricOptions=d;var f=b.widgetContext.getSettings().get("metric");f&&d.indexOf(f)>-1?b.metricValue=f:b.metricValue=d[0],b.metricDropdownOptions?b.metricDropdownOptions=null:b.metricDropdownOptions={},b.isMetricBusy=!1},function(b){a.onRequestError(b)})}},$("body").initialize("en-US"),this.isEntityBusy=!0,this.repeatSelect=null;var c=a.settingsData.settingsInstance,d=a.settingsData.settingsContext;this.widgetContext=d.getWidgetContext(),this.widgetInstanceId=this.widgetContext.getWidgetInstanceId(),this.widgetSettings=this.widgetContext.getSettings(),this.widgetTitle=this.widgetContext.getTitle()||this.widgetContext.getStandardTitle(),this.titleEditEnabled=this.widgetContext.isTitleEditEnabled();var e=this,f=new Date;this.dateTime=f.getTime().toString(),this.language=this.widgetContext.getLanguage(),this.textTitle=this.language.titleText||"Title",this.textEntity=this.language.textEntity||"Entity",this.textGroup=this.language.textGroup||"Group",this.textDimension=this.language.textDimension||"Dimension",this.textMetric=this.language.textMetric||"Metric",this.textType=this.language.textType||"Type",this.textLimit=this.language.textLimit||"Limit",c.closing=function(a){a.isSave&&(b.widgetContext.getSettings().set("entity",e.entityValue),b.widgetContext.getSettings().set("title",e.widgetTitle),b.widgetContext.setTitle(e.widgetTitle),b.widgetContext.getSettings().set("group",e.groupValue),b.widgetContext.getSettings().set("filter",e.dimensionValue),b.widgetContext.getSettings().set("metric",e.metricValue),b.widgetContext.getSettings().set("chartType",e.chartValue),b.widgetContext.getSettings().set("limitCount",e.limitCount))},this.chartOptions=["Bar","Column","Donut","Line","Pie"];var g=e.widgetContext.getSettings().get("chartType");g&&(this.chartValue=g),g=e.widgetContext.getSettings().get("limitCount"),g&&(this.limitCount=g),e.entityDropdownOptions=null;var h=e.widgetContext.getSettings().get("SDataApiContext"),i=h+"/SData/slx/metadata/-/entities?startIndex=0&count=300&where=filters.analyticsAvailable eq true and filters.filterType eq 'analyticsMetric'&select=name,displayName,tableName&orderBy=$descriptor&format=json&_t={0}";i=e.format([i,this.dateTime]);var j=this.createRequest(encodeURI(i));j.withCredentials=!0,this.widgetContext.executeIonApiAsync(j).then(function(a){var c,d,f=a.data.$resources,g=[];for(d=0;d<f.length;d++)c={name:f[d].name,value:f[d].tableName},g.push(c);e.entityOptions=g;var h=e.widgetContext.getSettings().get("entity"),i=!1;if(h&&h.value)for(d=0;d<g.length;d++)if(h.value===g[d].value){e.entityValue=g[d],i=!0;break}i===!1&&(e.entityValue=g[0]),b.entityDropdownOptions?b.entityDropdownOptions=null:b.entityDropdownOptions={},b.entityChanged(),e.isEntityBusy=!1},function(a){b.onRequestError(a)})}return a.prototype.onRequestError=function(a){this.textValue=this.language.errorOccured,this.isEntityBusy=!1,this.isGroupBusy=!1,this.isFilterBusy=!1,this.isMetricBusy=!1},a.prototype.createRequest=function(a){var b={method:"GET",url:a,cache:!1,headers:{Accept:"application/json"}};return b},a.prototype.setBusy=function(a){this.widgetContext.setState(a?c.WidgetState.busy:c.WidgetState.running)},a.add=function(b){b.controller("CustomSettingsCtrl",a)},a.prototype.format=function(a){for(var b=a[0],c=0;c<a.length-1;c++){var d=new RegExp("\\{"+c+"\\}","gm");b=b.replace(d,a[c+1])}return b},a.$inject=["$scope"],a}();b.widgetFactory=function(a){var b=a.getAngularContext().module;d.add(b),e.add(b);var c={angularConfig:{relativeTemplateUrl:"widget.html"}};return c}});
//# sourceMappingURL=chartwidget.js.map